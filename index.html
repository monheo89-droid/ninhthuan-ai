<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninh Thu·∫≠n AI - To√†n Di·ªán</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #ff9800; --success: #27ae60; --glass: rgba(255, 255, 255, 0.95); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; background: #000; }

        /* --- L·ªöP VIDEO GI·ªöI THI·ªÜU --- */
        #intro-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; 
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* --- H·ªÜ TH·ªêNG IFRAME (CHUY·ªÇN TAB) --- */
        .pano-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; z-index: 1; }
        .pano-page.active { visibility: visible; z-index: 10; }
        iframe { width: 100%; height: 100%; border: none; }

        /* --- CANVAS CH·ª§P ·∫¢NH AI --- */
        #ui-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }

        /* --- THANH ƒêI·ªÄU H∆Ø·ªöNG --- */
        .nav-bar { position: fixed; top: 20px; left: 20px; z-index: 10000; display: flex; gap: 12px; }
        .icon-btn { 
            width: 55px; height: 55px; border-radius: 50%; border: 3px solid #fff;
            background: #fff; font-size: 24px; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        #btn-vr.active { background: var(--primary); color: white; }
        #btn-shop.active { background: var(--success); color: white; }

        /* --- SIDEBAR AI --- */
        .ai-sidebar { 
            position: fixed; top: 85px; left: 20px; z-index: 9000; width: 280px; 
            background: var(--glass); padding: 20px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: 0.4s; transform-origin: top left;
        }
        .ai-sidebar.hidden { transform: scale(0); opacity: 0; }

        /* --- HI·ªÜU ·ª®NG PH·ª§ --- */
        #flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 20000; display: none; }
        #loading { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 20001; display: none; 
            flex-direction: column; align-items: center; justify-content: center; color: white; 
        }
        .loader { width: 30px; height: 30px; border: 4px solid #fff; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body id="main-capture">

    <div id="flash"></div>
    <div id="loading"><div class="loader"></div><p>AI ƒêANG T√ÅCH N·ªÄN...</p></div>

    <div class="nav-bar">
        <div class="icon-btn active" id="btn-vr" onclick="switchMode('vr')" title="üìç Tour VR">üìç</div>
        <div class="icon-btn" id="btn-shop" onclick="switchMode('shop')" title="üõí Gian h√†ng">üõí</div>
        <div class="icon-btn" id="btn-ai" onclick="toggleAI()" title="üì∑ Ch·ª•p h√¨nh AI">üì∑</div>
    </div>

    <div id="intro-overlay">
        <video id="v-intro" autoplay muted loop playsinline>
            <source src="https://monheo89-droid.github.io/ninhthuan-ai/video/intro.mp4" type="video/mp4">
        </video>
    </div>

    <div class="ai-sidebar hidden" id="ai-menu">
        <h3 style="margin-top:0; font-size:18px;">B∆∞u Thi·∫øp AI</h3>
        <label style="display:block; background:var(--primary); color:white; padding:12px; text-align:center; border-radius:10px; cursor:pointer; font-weight:bold;">
            üì∏ T·∫¢I ·∫¢NH NG∆Ø·ªúI
            <input type="file" hidden onchange="processAIPerson(this)">
        </label>
        
        <div id="ai-tools" style="display:none; margin-top:15px;">
            <p style="font-size:12px; margin-bottom:5px;">Ph√≥ng to/Thu nh·ªè:</p>
            <input type="range" id="person-size" min="0.2" max="2.0" step="0.01" value="1.0" oninput="drawCanvas()" style="width:100%">
            <button onclick="savePostcard()" style="width:100%; padding:12px; margin-top:15px; border:none; border-radius:10px; background:var(--success); color:white; font-weight:bold; cursor:pointer;">
                üéÅ XU·∫§T B∆ØU THI·∫æP
            </button>
        </div>
    </div>

    <div id="page-vr" class="pano-page active">
        <iframe src="https://tour.panoee.net/68972f4ba3c49352552578cd/68c2e05f65c1d76691a79f7c"></iframe>
    </div>
    <div id="page-shop" class="pano-page">
        <iframe src="https://tour.panoee.net/68972f4ba3c49352552578cd/691b32dc061521c90def58cb"></iframe>
    </div>

    <canvas id="ui-canvas"></canvas>

    <script>
        const API_KEY = "FtyKLHXkG5By3gFBCBcoTACC";
        const canvas = document.getElementById('ui-canvas');
        const ctx = canvas.getContext('2d');
        let personImg = null;
        let imgPos = { x: 0, y: 0, w: 0, h: 0 };

        window.onload = () => { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        };

        // --- T√çNH NƒÇNG 1: CHUY·ªÇN TAB & 2: C·∫ÆT VIDEO ---
        function switchMode(mode) {
            // X√≥a video ngay l·∫≠p t·ª©c khi click icon
            const overlay = document.getElementById('intro-overlay');
            if (overlay) {
                document.getElementById('v-intro').pause();
                overlay.remove();
            }

            // Chuy·ªÉn tab hi·ªÉn th·ªã (kh√¥ng load l·∫°i iframe)
            document.querySelectorAll('.pano-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('page-' + mode).classList.add('active');
            document.getElementById('btn-' + mode).classList.add('active');
        }

        // --- T√çNH NƒÇNG 3: CH·ª§P ·∫¢NH AI ---
        function toggleAI() {
            const overlay = document.getElementById('intro-overlay');
            if (overlay) switchMode('vr'); // T·∫Øt video n·∫øu ƒëang hi·ªán
            document.getElementById('ai-menu').classList.toggle('hidden');
        }

        async function processAIPerson(input) {
            if (!input.files[0]) return;
            document.getElementById('loading').style.display = 'flex';

            const formData = new FormData();
            formData.append("image_file", input.files[0]);

            try {
                const response = await fetch("https://api.remove.bg/v1.0/removebg", {
                    method: "POST",
                    headers: { "X-Api-Key": API_KEY },
                    body: formData
                });

                const blob = await response.blob();
                personImg = new Image();
                personImg.onload = () => {
                    const ratio = personImg.width / personImg.height;
                    imgPos.h = 500; 
                    imgPos.w = 500 * ratio;
                    imgPos.x = (canvas.width - imgPos.w) / 2;
                    imgPos.y = canvas.height - imgPos.h - 50;
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('ai-tools').style.display = 'block';
                    drawCanvas();
                };
                personImg.src = URL.createObjectURL(blob);
            } catch (error) {
                alert("L·ªói AI t√°ch n·ªÅn!");
                document.getElementById('loading').style.display = 'none';
            }
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (personImg) {
                const scale = document.getElementById('person-size').value;
                ctx.drawImage(personImg, imgPos.x, imgPos.y, imgPos.w * scale, imgPos.h * scale);
            }
        }

        // CH·ª§P TO√ÄN C·∫¢NH V√Ä L∆ØU FILE
        function savePostcard() {
            // Hi·ªáu ·ª©ng Flash ch·ª•p ·∫£nh
            const flash = document.getElementById('flash');
            flash.style.display = 'block';
            setTimeout(() => flash.style.display = 'none', 150);

            // Ch·ª•p to√†n b·ªô v√πng body (bao g·ªìm Iframe + Canvas)
            html2canvas(document.body, {
                useCORS: true, 
                allowTaint: true
            }).then(canvasResult => {
                const link = document.createElement('a');
                link.download = 'NinhThuanAI_Souvenir.png';
                link.href = canvasResult.toDataURL("image/png");
                link.click();
            });
        }
    </script>
</body>
</html>
