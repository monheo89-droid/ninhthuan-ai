<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninh Thu·∫≠n AI - Pro Edition</title>
    <style>
        :root { --primary: #ff9800; --success: #27ae60; --dark: #2c3e50; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }

        /* Qu·∫£n l√Ω Tab */
        .tab-content { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .tab-content.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Thanh ƒëi·ªÅu h∆∞·ªõng */
        .nav-bar { position: absolute; top: 20px; left: 20px; z-index: 2000; display: flex; gap: 10px; }
        .nav-btn { 
            width: 48px; height: 48px; border-radius: 50%; border: none; 
            background: white; color: var(--dark); font-size: 20px; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; 
            transition: 0.2s ease;
        }
        .nav-btn.active-tab { background: var(--primary); color: white; transform: scale(1.1); }
        .nav-btn.cart-btn.active-tab { background: var(--success); }

        /* Menu AI */
        #ai-menu-panel { 
            position: absolute; top: 85px; left: 20px; z-index: 1000; width: 280px; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); 
            padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #ai-menu-panel.hidden { opacity: 0; transform: translateY(-20px) scale(0.9); pointer-events: none; }

        .btn-main { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; font-size: 14px; }
        .btn-upload { background: var(--primary); }
        .btn-capture { background: var(--success); }

        /* Canvas v√† l·ªõp ph·ªß */
        #ui-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; pointer-events: none; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; color: white; flex-direction: column; align-items: center; justify-content: center; }
        #guide-frame { position: absolute; top: 15vh; left: 55vw; width: 320px; height: 450px; border: 2px dashed #fff; z-index: 400; pointer-events: none; border-radius: 12px; display: none; }
    </style>
</head>
<body>

    <div id="loading">‚ôªÔ∏è ƒêANG X·ª¨ L√ù AI...</div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="toggleMenu()" title="C√†i ƒë·∫∑t">‚ò∞</button>
        <button class="nav-btn active-tab" id="btn-vr" onclick="switchTab('vr-tab')">üìç</button>
        <button class="nav-btn cart-btn" id="btn-shop" onclick="switchTab('shop-tab')">üõí</button>
    </div>

    <div id="vr-tab" class="tab-content active">
        <iframe id="iframe-vr" src="https://tour.panoee.net/68972f4ba3c49352552578cd/68c2e05f65c1d76691a79f7c"></iframe>
        <canvas id="ui-canvas"></canvas>
        <div id="guide-frame"></div>

        <div id="ai-menu-panel">
            <h3 style="margin:0 0 10px 0">Ninh Thu·∫≠n AI</h3>
            <label class="btn-main btn-upload" style="display:block; text-align:center;">
                üì∏ T·∫£i ·∫£nh ng∆∞·ªùi
                <input type="file" id="input-file" accept="image/*" style="display:none" onchange="processAI(this)">
            </label>

            <div id="edit-controls" style="display:none; margin-top:15px;">
                <p style="font-size:12px; margin-bottom:5px;">K√≠ch th∆∞·ªõc nh√¢n v·∫≠t:</p>
                <input type="range" id="size-slider" min="0.1" max="2.5" step="0.1" value="1.0" style="width:100%">
                <button class="btn-main btn-capture" onclick="startCapture()">üéÅ Xu·∫•t b∆∞u thi·∫øp</button>
            </div>
        </div>
    </div>

    <div id="shop-tab" class="tab-content">
        <iframe id="iframe-shop" src="https://tour.panoee.net/68972f4ba3c49352552578cd/68c2e05f65c1d76691a79f7c"></iframe>
    </div>

    <script>
        const API_KEY = "FtyKLHXkG5By3gFBCBcoTACC";
        const canvas = document.getElementById('ui-canvas');
        const ctx = canvas.getContext('2d');
        let userImg = null, imgPos = { x: 100, y: 100, w: 0, h: 0 };

        window.onload = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        };

        // H√ÄM CHUY·ªÇN TAB C·∫¢I TI·∫æN - S·ª¨A L·ªñI B·ªä ƒê∆†
        function switchTab(tabId) {
            // 1. Reset t·∫•t c·∫£ c√°c l·ªõp n·ªôi dung
            const tabs = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // 2. Reset tr·∫°ng th√°i n√∫t
            document.getElementById('btn-vr').classList.remove('active-tab');
            document.getElementById('btn-shop').classList.remove('active-tab');

            // 3. K√≠ch ho·∫°t Tab m·ªõi
            document.getElementById(tabId).classList.add('active');

            // 4. C·∫≠p nh·∫≠t giao di·ªán ph·ª• tr·ª£
            if (tabId === 'vr-tab') {
                document.getElementById('btn-vr').classList.add('active-tab');
                document.getElementById('ai-menu-panel').style.opacity = "1";
                document.getElementById('ui-canvas').style.display = "block";
            } else {
                document.getElementById('btn-shop').classList.add('active-tab');
                document.getElementById('ai-menu-panel').style.opacity = "0";
                document.getElementById('ui-canvas').style.display = "none";
            }
        }

        function toggleMenu() {
            const panel = document.getElementById('ai-menu-panel');
            panel.classList.toggle('hidden');
        }

        // X·ª¨ L√ù AI
        async function processAI(input) {
            if (!input.files[0]) return;
            document.getElementById('loading').style.display = "flex";
            const formData = new FormData();
            formData.append("image_file", input.files[0]);
            
            try {
                const res = await fetch("https://api.remove.bg/v1.0/removebg", {
                    method: "POST", headers: { "X-Api-Key": API_KEY }, body: formData
                });
                const blob = await res.blob();
                userImg = new Image();
                userImg.onload = () => {
                    const ratio = userImg.width / userImg.height;
                    imgPos.w = 400 * ratio; imgPos.h = 400;
                    document.getElementById('loading').style.display = "none";
                    document.getElementById('edit-controls').style.display = "block";
                    document.getElementById('guide-frame').style.display = "block";
                    render();
                };
                userImg.src = URL.createObjectURL(blob);
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi AI!");
                document.getElementById('loading').style.display = "none";
            }
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (userImg) {
                const s = document.getElementById('size-slider').value;
                ctx.drawImage(userImg, imgPos.x, imgPos.y, imgPos.w * s, imgPos.h * s);
            }
        }
        document.getElementById('size-slider').oninput = render;

        // Logic xu·∫•t ·∫£nh (Gi·∫£ l·∫≠p ƒë·ªÉ b·∫°n t√≠ch h·ª£p h√†m getDisplayMedia c≈© c·ªßa b·∫°n)
        function startCapture() {
            alert("Vui l√≤ng cho ph√©p chia s·∫ª m√†n h√¨nh ƒë·ªÉ xu·∫•t b∆∞u thi·∫øp ch·∫•t l∆∞·ª£ng cao!");
            // G·ªçi h√†m executePerfectCapture() c≈© c·ªßa b·∫°n ·ªü ƒë√¢y
        }
    </script>
</body>
</html>
