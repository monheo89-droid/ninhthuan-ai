<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninh Thu·∫≠n AI - Smooth Edition</title>
    <style>
        :root { --primary: #ff9800; --success: #27ae60; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        
        /* Iframe t·ªëi ∆∞u h√≥a */
        .pano-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; }
        .pano-page.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; }

        /* UI t·ªëi gi·∫£n ƒë·ªÉ nh·∫π m√°y */
        .top-btns { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
        .btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        /* Canvas layer */
        #ui-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        
        /* Loading nh·∫π */
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; color: white; justify-content: center; align-items: center; z-index: 9999; }
        
        /* Hotspot ƒë∆°n gi·∫£n */
        .hotspot { position: absolute; width: 20px; height: 20px; background: red; border-radius: 50%; border: 2px solid white; cursor: pointer; pointer-events: auto; z-index: 200; }
    </style>
</head>
<body>

<div id="loading">ƒêANG X·ª¨ L√ù...</div>

<div class="top-btns">
    <button class="btn" onclick="switchTab('vr')">üìç</button>
    <button class="btn" onclick="switchTab('shop')" style="background:var(--success)">üõí</button>
    <button class="btn" onclick="toggleAI()">üì∑</button>
</div>

<div id="page-vr" class="pano-page active">
    <iframe src="https://tour.panoee.net/68972f4ba3c49352552578cd/68c2e05f65c1d76691a79f7c"></iframe>
</div>
<div id="page-shop" class="pano-page">
    <iframe src="https://tour.panoee.net/68972f4ba3c49352552578cd/691b32dc061521c90def58cb"></iframe>
</div>

<canvas id="ui-canvas"></canvas>

<script>
    const canvas = document.getElementById('ui-canvas');
    const ctx = canvas.getContext('2d');
    let userImg = null;

    // Fix l·ªói ƒë∆°: Ch·ªâ resize canvas khi th·ª±c s·ª± c·∫ßn
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        render();
    }
    window.addEventListener('resize', resize);
    resize();

    function switchTab(tab) {
        document.querySelectorAll('.pano-page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + tab).classList.add('active');
        // Gi·∫£i ph√≥ng canvas khi chuy·ªÉn tab ƒë·ªÉ m√°y m∆∞·ª£t h∆°n
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function toggleAI() {
        // Thay v√¨ hi·ªán menu ph·ª©c t·∫°p, ch·ªâ k√≠ch ho·∫°t input file ƒë·ªÉ ti·∫øt ki·ªám RAM
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => processImage(e.target.files[0]);
        input.click();
    }

    async function processImage(file) {
        if (!file) return;
        document.getElementById('loading').style.display = 'flex';
        
        // Gi·∫£ l·∫≠p t√°ch n·ªÅn ƒë·ªÉ tr√°nh treo m√°y n·∫øu API ch·∫≠m
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                userImg = img;
                render();
                document.getElementById('loading').style.display = 'none';
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    function render() {
        if (!userImg) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // V·∫Ω ·∫£nh ·ªü g√≥c m√†n h√¨nh ƒë·ªÉ tr√°nh che khu·∫•t Tour
        ctx.drawImage(userImg, 20, canvas.height - 220, 150, 200);
    }

    // C∆° ch·∫ø ch·ª•p ·∫£nh an to√†n: D√πng MediaDevices thay v√¨ html2canvas
    async function safeCapture() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            // X·ª≠ l√Ω stream ·ªü ƒë√¢y...
            stream.getTracks().forEach(t => t.stop());
        } catch (err) {
            console.log("Ng∆∞·ªùi d√πng h·ªßy ch·ª•p");
        }
    }
</script>
</body>
</html>
