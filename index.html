<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ninh Thuáº­n AI - Fix Drag</title>
    <style>
        :root { --primary: #ff9800; --success: #27ae60; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        /* Iframe */
        .pano-page { position: absolute; inset: 0; display: none; z-index: 1; }
        .pano-page.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Canvas - Quan trá»ng: pointer-events auto Ä‘á»ƒ báº¯t Ä‘Æ°á»£c sá»± kiá»‡n kÃ©o */
        #ui-canvas { 
            position: absolute; inset: 0; z-index: 100; 
            pointer-events: none; /* Máº·c Ä‘á»‹nh táº¯t Ä‘á»ƒ xoay Tour */
        }
        #ui-canvas.active { pointer-events: auto; cursor: move; }

        /* UI */
        .top-nav { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
        .btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; font-size: 20px; }
        
        .panel { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px; background: rgba(255,255,255,0.9);
            padding: 15px; border-radius: 15px; z-index: 1100; display: none; text-align: center;
        }

        #guide-text {
            position: absolute; top: 80px; width: 100%; text-align: center;
            color: white; font-weight: bold; text-shadow: 2px 2px 4px #000; z-index: 1000; display: none;
        }
    </style>
</head>
<body>

<div id="guide-text">DÃ™NG TAY KÃ‰O NGÆ¯á»œI Äá»‚ DI CHUYá»‚N</div>

<div class="top-nav">
    <button class="btn" onclick="switchTab('vr')">ğŸ“</button>
    <button class="btn" onclick="switchTab('shop')" style="background:var(--success)">ğŸ›’</button>
    <button class="btn" onclick="toggleStudio()">ğŸ“·</button>
</div>

<div id="page-vr" class="pano-page active"><iframe src="https://tour.panoee.net/68972f4ba3c49352552578cd/68c2e05f65c1d76691a79f7c"></iframe></div>
<div id="page-shop" class="pano-page"><iframe src="https://tour.panoee.net/68972f4ba3c49352552578cd/691b32dc061521c90def58cb"></iframe></div>

<canvas id="ui-canvas"></canvas>

<div class="panel" id="studio-panel">
    <input type="file" id="inp" hidden onchange="loadImage(this)">
    <button onclick="document.getElementById('inp').click()" style="width:100%; padding:10px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:bold;">Táº¢I áº¢NH NGÆ¯á»œI</button>
    <div id="ctrl" style="display:none; margin-top:10px;">
        <input type="range" id="sc" min="0.1" max="2" step="0.05" value="0.6" style="width:100%" oninput="draw()">
        <p style="font-size:12px; margin:5px 0;">KÃ©o trá»±c tiáº¿p lÃªn ngÆ°á»i Ä‘á»ƒ di chuyá»ƒn</p>
    </div>
</div>

<script>
    const cvs = document.getElementById('ui-canvas');
    const ctx = cvs.getContext('2d');
    let img = null, x = 100, y = 100, scale = 0.6, isDrag = false;

    function resize() {
        cvs.width = window.innerWidth;
        cvs.height = window.innerHeight;
        draw();
    }
    window.addEventListener('resize', resize);
    resize();

    function toggleStudio() {
        const panel = document.getElementById('studio-panel');
        const isOpening = panel.style.display !== 'block';
        panel.style.display = isOpening ? 'block' : 'none';
        document.getElementById('guide-text').style.display = isOpening ? 'block' : 'none';
        cvs.classList.toggle('active', isOpening); // Báº­t/táº¯t kháº£ nÄƒng báº¯t sá»± kiá»‡n cá»§a canvas
    }

    function switchTab(t) {
        document.querySelectorAll('.pano-page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + t).classList.add('active');
        cvs.classList.remove('active');
        document.getElementById('studio-panel').style.display = 'none';
    }

    function loadImage(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const newImg = new Image();
            newImg.onload = () => {
                img = newImg;
                x = cvs.width/2 - (img.width*scale)/2;
                y = cvs.height/2 - (img.height*scale)/2;
                document.getElementById('ctrl').style.display = 'block';
                draw();
            };
            newImg.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        if (img) {
            scale = document.getElementById('sc').value;
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        }
    }

    // --- LOGIC KÃ‰O THáº¢ ÄA ÄIá»‚M (MOUSE + TOUCH) ---
    function getPos(e) {
        const rect = cvs.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function onStart(e) {
        if (!img) return;
        const pos = getPos(e);
        // Kiá»ƒm tra xem cÃ³ nháº¥n trÃºng vÃ o vÃ¹ng áº£nh khÃ´ng
        if (pos.x >= x && pos.x <= x + img.width * scale &&
            pos.y >= y && pos.y <= y + img.height * scale) {
            isDrag = true;
            e.preventDefault();
        }
    }

    function onMove(e) {
        if (!isDrag) return;
        const pos = getPos(e);
        x = pos.x - (img.width * scale) / 2;
        y = pos.y - (img.height * scale) / 2;
        draw();
        e.preventDefault();
    }

    function onEnd() { isDrag = false; }

    // Sá»± kiá»‡n Chuá»™t
    cvs.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);

    // Sá»± kiá»‡n Cáº£m á»©ng (Äiá»‡n thoáº¡i)
    cvs.addEventListener('touchstart', onStart, {passive: false});
    cvs.addEventListener('touchmove', onMove, {passive: false});
    cvs.addEventListener('touchend', onEnd);

</script>
</body>
</html>
